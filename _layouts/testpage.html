<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Bicycle Theft in London – Leaflet Heatmap Template</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.11.1/tachyons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

</head>

<body class="helvetica">

  <div id="map" class="vh-100 vw-100 bg-near-white"></div>

  

  <script>
    /*** Data File String Reference Values ***/
    op_atlas_college_grad = 'https://raw.githubusercontent.com/CodeChanning/stem_map/gh-pages/_layouts/opp_atlas_collegegraduationrate_data.csv';

    nsf_school_funding = 'https://raw.githubusercontent.com/CodeChanning/stem_map/gh-pages/stem_map_data/nsf_school_state_funding%20(1)%20-%20primary-08-1%20(1).csv';
    
    var heat;
    var marker

    /*** MAP -- MAKING ***/
    
    //Making base map
    var map = L.map('map', {
      zoomControl: false, // Add zoom control separately below
      center: [39.8333333, -100.585522], // Initial map center
      zoom: 4, // Initial zoom level
      //maxZoom: 20,
      attributionControl: false, // Instead of default attribution, we add custom at the bottom of script
      scrollWheelZoom: true
    })

    // Add zoom in/out buttons to the top-right
    L.control.zoom({position: 'topright'}).addTo(map)

    // Add baselayer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map)

    // Add geographical labels only layer on top of baselayer
    var labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19,
      pane: 'shadowPane'  // always display on top
    }).addTo(map)

    //adding icon for marker
    var dotIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/CodeChanning/stem_map/gh-pages/_layouts/dot.png',
        iconSize: [10, 10]
      });

    /*** MAKING HEAT MAPS WITH DATA ***/
    

    // Add custom attribution
    L.control.attribution({
      prefix: '<a href="https://github.com/HandsOnDataViz/leaflet-heatmap">View data and code</a> \
        by <a href="https://handsondataviz.org" target="_blank">HandsOnDataViz</a>'
    }).addTo(map)

    function csvProcessor(data, markerText, latIndex, lngIndex, intensityIndex, length, equalizer){
      // Read data from CSV file
      $.get(data, 
      function(csvString) {
      var count = 0;
      // Use PapaParse to transform file into arrays
      var data = Papa.parse(csvString.trim()).data.filter(
      function(row) { return row.length === length }
      ).map(function(a) {   
        count++;
        console.log(count)
        
        console.log(a[0], a[latIndex], a[lngIndex], a[intensityIndex])
      return [parseFloat(a[latIndex]), parseFloat(a[lngIndex]), parseFloat(a[intensityIndex])]
      })
      
      intensityVals = [];

      data = data.filter(function(elem){
        console.log(elem[0]);
        console.log(Object.is(elem[0], NaN));
        return !Object.is(elem[0], NaN);
      })
      
      //adding markers for every city that display the grad rate for that place
      for(var i = 0;  i < data.length; i++){
        console.log(i + 1)
        console.log(data[i]);
        if(Object.is(data[i][0], NaN) || Object.is(data[i][1], NaN) || Object.is(data[i][2], NaN)){
          console.log("SKIP ");
          console.log(data)
          data.splice
        }
        var latlng = new L.LatLng(data[i][0], data[i][1]);

        marker = L.marker(latlng ,{icon: dotIcon}).addTo(map);
        marker.bindPopup(markerText + data[i][2] + "");
        console.log (data[i] + " " + i);

        data[i][2] = data[i][2] / 1000;
        intensityVals.push(data[i][2]);
      } 
      
     max = Math.max.apply(null, intensityVals);
     console.log(intensityVals)
     console.log();
      // Add all points into a heat layer
      //console.log(max)
      heat = L.heatLayer(data, {
        
        max: max,
        radius: 20,
        blur: 3,
        maxZoom: 1,
        gradient: { 0.0: 'red', 1.0:'blue'}
      })
      
      
      // Add the heatlayer to the map
      heat.addTo(map)
      console.log("I'M HERE");
      })
    }
    
    function clickCodecomments(){
      //Displays popup wherever the user clicks
    /*var har = new L.LatLng(46.435512,	-109.8343499);
    
    var popup = L.popup({lat: 46.435512, lon: -109.8343499})
    .setLatLng()
    .setContent('<p>Hello world!<br />This is a nice popup.</p>')
    .openOn(map);
    
    console.log(popup.getLatLng());
    map.on('click', function(e) {        
        var popLocation= e.latlng;
        var popup = L.popup()
        .setLatLng(popLocation)
        .setContent("does this work?")
        .openOn(map);        
    });*/

    //binding popup to marker
    /*var marker = L.marker(har).addTo(map);
    marker.bindPopup("hello??").openPopup();*/
    }
  
  </script>

<div id="legend" class="bg-white fixed top-0 left-0 pa2 mt2 ml2 br1 o-90" style="z-index: 999; width: 380px">
    <h1 class="f3 mt0">Bicycle Theft in London</h1>
    
    <!--
    <p class="measure mb1">
      This heatmap shows hotspots of bicycle theft in London
      in January–July 2020 according to the Metropolitan Police data.
    </p> -->

    <button onclick=' csvProcessor(op_atlas_college_grad, "College Graduation Rate: ", 2, 3, 4, 5, 1);
    '>College Graduation Rate</button>
    <button onClick='map.removeLayer(heat); marker.clearLayers(); console.log("lmao"); csvProcessor(nsf_school_funding, "State School Funding (In Millions): $", 1, 2, 8, 15, 1000);'>State School Funding</button>

  </div>

</body>

</html>